// Passaporte do Leitor - Database Schema
// Using Neon PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum LevelCategory {
  MAGIC
  EXPLORERS
  KNIGHTS
  SPACE
}

enum Genre {
  FANTASIA
  AVENTURA
  ESPACO
  NATUREZA
  MISTERIO
  OCEANO
  CIENCIA
  HISTORIA
}

// ============================================================================
// MODELOS PRINCIPAIS
// ============================================================================

model Family {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  password  String?  // Hashed, opcional para MVP
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  children Child[]
  settings FamilySettings?

  @@map("families")
}

model FamilySettings {
  id       String @id @default(cuid())
  familyId String @unique
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  // Prefer√™ncias
  language       String  @default("pt-PT")
  notifications  Boolean @default(true)
  weeklyReport   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("family_settings")
}

model Child {
  id            String        @id @default(cuid())
  familyId      String
  name          String
  avatar        String        @default("üë¶")
  birthYear     Int?
  levelCategory LevelCategory @default(EXPLORERS)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  family           Family            @relation(fields: [familyId], references: [id], onDelete: Cascade)
  books            Book[]
  readingSessions  ReadingSession[]
  achievements     ChildAchievement[]

  @@map("children")
}

model Book {
  id       String @id @default(cuid())
  childId  String
  child    Child  @relation(fields: [childId], references: [id], onDelete: Cascade)

  // Informa√ß√£o do livro
  title    String
  author   String
  isbn     String?
  genre    Genre
  totalPages Int?

  // Estado de Leitura
  status          String    @default("to-read") // to-read, reading, finished
  currentPage     Int?
  startDate       DateTime?
  finishDate      DateTime?
  
  // Avalia√ß√£o
  rating            Int?      // 1-5
  notes             String?   // "O que achou"
  favoriteCharacter String?
  recommended       Boolean?
  
  // Datas de registo
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  readingSessions ReadingSession[]

  @@index([childId])
  @@index([genre])
  @@map("books")
}

model Achievement {
  id          String @id @default(cuid())
  code        String @unique
  name        String
  description String
  icon        String
  category    AchievementCategory @default(READING)
  
  // Requisitos (JSON para flexibilidade)
  requirements Json @default("{}")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  childAchievements ChildAchievement[]

  @@map("achievements")
}

model ChildAchievement {
  id            String   @id @default(cuid())
  childId       String
  child         Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  earnedAt      DateTime @default(now())

  @@unique([childId, achievementId])
  @@map("child_achievements")
}

enum AchievementCategory {
  READING    // Relacionado com quantidade de leitura
  GENRE      // Relacionado com g√©neros
  STREAK     // Relacionado com consist√™ncia
  SPECIAL    // Conquistas especiais
}

// ============================================================================
// √çNDICES ADICIONAIS PARA PERFORMANCE
// ============================================================================

// Os √≠ndices principais j√° est√£o definidos acima com @@index

model ReadingSession {
  id        String   @id @default(cuid())
  childId   String
  child     Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  
  // Dados da sess√£o
  date      DateTime @default(now())  // Dia da sess√£o
  minutes   Int                        // Dura√ß√£o em minutos (obrigat√≥rio)
  
  // Livro (obrigat√≥rio)
  bookId    String
  book      Book     @relation(fields: [bookId], references: [id])
  
  // Progresso (opcional)
  pageEnd   Int?                       // P√°gina onde terminou
  
  // Feedback (opcional)
  mood      Int?     @default(3)       // 1-5 (üò´ a ü§©)
  
  // Terminou o livro nesta sess√£o?
  finishedBook Boolean @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([childId])
  @@index([childId, date])
  @@index([bookId])
  @@map("reading_sessions")
}
